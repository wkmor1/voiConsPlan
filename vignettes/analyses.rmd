```{r package_setup, cache = FALSE}
library(ALA4R)
library(dplyr)
library(doSNOW)
library(foreach)
library(ggplot2)
library(gridExtra)
library(raster)
library(rgdal)
library(rzonation)
library(scales)
library(viridis)
library(voiConsPlan)
library(xtable)

ala_config(cache_directory = ".")
```

```{r variables}
n_bg_points <- 1e4L

n_sp_points <- 30L

n_cl_nodes <- 36L

n_bs_samp <- 1e3L

prop_loss <- .9

resolution <- 1e3L

projection <- "+init=epsg:28356"

hunter_lgas <- c("Cessnock",       "Dungog",                  "Gloucester",
                 "Gosford",        "Greater Taree",           "Great Lakes",
                 "Lake Macquarie", "Maitland",                "Muswellbrook",
                 "Newcastle",      "Port Macquarie-Hastings", "Port Stephens",
                 "Singleton",      "Upper Hunter",            "Wyong")

predictor_names <- c("Annual Mean Radiation", "Annual Mean Temperature",
                     "Annual Precipitation",  "Precipitation Seasonality", 
                     "Soil Fertility",        "Topographic Wetness")

species_groups  <- c("Birds",               "Mammals",               "Plants")
spp_of_interest <- c("Anthochaera phrygia", "Dasyurus maculatus",    "Acacia bynoeana",
                     "Ninox strenua",       "Petaurus norfolcensis", "Melaleuca groveana")

zonation_settings <- list("removal rule" = 2, "warp factor" = 10)
```

```{r get_data, eval = FALSE, echo = FALSE}
predictor_sources <- c("http://www.abs.gov.au/", "http://www.bom.gov.au/",
                       "http://data.environment.nsw.gov.au/")

predictor_paths <- c("Ausstats/subscriber.nsf/0/56A7AA594A7F44F9CA2578CC0011CE44/$File/1259030001_sla11aaust_shape.zip",
                     "web01/ncc/www/climatology/solar_radiation/solaran.zip",
                     "dataset/D793E5CD-3DF6-4F76-9DBF-12CEDF46795A/resource/cdc0fc7a-8e67-4d67-964e-f6640a8f117a/download/soilinherentsoilfertilityofnsw.zip")

predictor_dest_files <- c("SLA11aAust.zip", "srad.zip", "soilNSW.zip")

coords <- c("longitude", "latitude")

filters <- c("decimalLatLongConversionFailed", "habitatMismatch",
             "detectedOutlier",                "geodeticDatumAssumedWgs84",
             "nameNotRecognised",              "speciesOutsideExpertRange",
             "coordinatePrecisionMismatch",    "invalidScientificName", 
             "unrecognizedGeodeticDatum",      "invalidGeodeticDatum", 
             "inferredDuplicateRecord")

mapply(get_zip, predictor_sources, predictor_paths,
       predictor_dest_files)

hunter_poly <- readOGR(".", "SLA11aAust")

hunter_poly <-
  subset(
    hunter_poly,
    SLA_NAME11 %in%
      grep(
        paste(hunter_lgas, collapse = "|"),
        hunter_poly$SLA_NAME11,
        value = TRUE
      )
  ) %>% aggregate

hunter_extent <- extent(hunter_poly)

hunter_alt <-
  getData("alt", country = "AUS") %>%
  crop(hunter_extent, snap = "out") %>% 
  projectRaster(crs = projection, res = 924L)

predictors <-
  list(
    projectRaster(raster("solaran.txt"), hunter_alt),
    projectRaster(get_bioclim(1,  hunter_extent) / 10, hunter_alt),
    projectRaster(get_bioclim(12, hunter_extent), hunter_alt),
    projectRaster(get_bioclim(15, hunter_extent), hunter_alt),
    readOGR(".", "InherentSoilFertility") %>%
      spTransform(CRS(projection)) %>%
      rasterize(hunter_alt, "Fert_value") %>%
      reclassify(cbind(6:7, NA)),
    twi(hunter_alt)
  ) %>%
  setNames(predictor_names) %>%
  brick %>%
  mask(spTransform(hunter_poly, CRS(projection))) %>%
  projectRaster(crs = projection, res = resolution)

predictors <- mask(predictors, calc(predictors, sum))

hunter_alt <-
  projectRaster(hunter_alt, crs = projection, res = resolution) %>%
  mask(predictors[[1]])

occurrence_records <-
  lapply(
    species_groups, dload_records, filters, hunter_poly, projection, hunter_alt,
    coords
  ) %>%
  bind_rows

save(predictors, file = "~/voiConsPlan/data/predictors.rda", compress = "xz")
save(occurrence_records, file = "~/voiConsPlan/data/occurrence_records.rda", compress = "xz")
```

```{r sample_occurrences}
set.seed(19831111)

spp_fltr <-
  paste(gsub(" ", ".*", spp_of_interest), collapse = "|") %>%
  sprintf("grepl('%s', species)", .)

species_occurrences <-
  filter_(occurrence_records, spp_fltr) %>%
  mutate(
    species = factor(gsub(" \\W.*\\W ", " ", species), levels = spp_of_interest)
  ) %>%
  group_by(species) %>%
  sample_n(n_sp_points)

background <-
  filter_(occurrence_records, paste0("!", spp_fltr)) %>%
  group_by(species_group) %>%
  sample_n(n_bg_points)
```

```{r models_boot, cache.lazy = FALSE}
bs_samples <-
  replicate(
    n_bs_samp, 
    sample_n(species_occurrences, n_sp_points, replace = TRUE),
    simplify = FALSE
  )

cl <- makeCluster(n_cl_nodes)
registerDoSNOW(cl)

models_boot <-
  foreach(bs_sample = bs_samples,
          .packages = c("dismo", "dplyr", "voiConsPlan")) %dopar% {
    lapply(spp_of_interest, fit_maxent_model, bs_sample, background,
           predictors) %>%
    lapply(project_maxent, predictors) %>% brick
  }

stopCluster(cl)

models_boot_by_sp <-
  seq_along(spp_of_interest) %>%
  lapply(extract_layers, models_boot) %>%
  lapply(brick)
```

```{r models}
models <- lapply(models_boot_by_sp, calc, mean) %>% brick
```

```{r plan}
plan <- zonation(models, settings = zonation_settings)
```

```{r evwoi}
evwoi <- ave_prop_rem(models, get_rank(plan), prop_loss)
```

```{r plan_boot}
cl <- makeCluster(n_cl_nodes)
registerDoSNOW(cl)

plans_boot <-
  foreach(models = models_boot, .packages = c("dplyr", "rzonation")) %dopar% {
    zonation(models, settings = zonation_settings) %>% get_rank
  }

stopCluster(cl)
```

```{r evwpi}
evwpi <-
  mapply(
    ave_prop_rem, models_boot, plans_boot, MoreArgs = list(p = prop_loss)
  ) %>%
  mean
```
