***

Box 3: A simple example of calculating the value of information for a conservation plan using Zonation
------------------------------------------------------------------------------------------------------

```{r plot_simple_zonation, fig.cap = "How to calculate the value of information for a conservation plan for 2 species, 25 cells and a budget large enough to purchase 1 cell, using zonation. First calculate the EVWOI (top row). With original information we rank each cell using the maps of expected carrying capacity (top left quadrant). For the highest rank cell (greyed out cell, top right quandrant) take the average proportion of carrying capacity remaining with all other unprotected cells are removed (top equation. Next calculate EVWPI. For each set of bootstrapped species carrying capacity maps $k_1$ and $k_2$ rank each cell and calcualte the average proportion of carrying capacity remaining. The EVWPI is the average of the average proportion of carrying capacity remaining for each bootstrap sample $k_1$ and $k_2$ (middle equation). Finally we calculate EVPI which is the difference between the EVWOI and EVWPI (bottom equation)"}
  local(
    {
      build_raster <-
        function(n, n_layers, shape1 = 1, shape2 = 1) {
          dist <- array(NA_real_, dim = c(n + 2, n + 2, n_layers))
          dist[-c(1, n + 2), -c(1, n + 2), ] <-
            array(
              replicate(n_layers, rbeta(n ^ 2, shape1, shape2)),
              dim = c(n, n, n_layers)
            )
          dist
        }
    
      apr <-
        function(loss, pln, fs) {
          mean(
            raster::cellStats(fs * (pln$rasters$rank >= loss), sum) /
              raster::cellStats(fs, sum)
          )
        }
    
      n <- 5
      n_layers <- 2L
      n_species <- 2L
      loss <- ((n ^ 2L) - 1L) / (n ^ 2L)
    
      set.seed(0)
    
      features <- replicate(n_species, build_raster(n, n_layers))
    
      E_features <- raster::brick(apply(features, c(1, 2, 4), mean))
    
      E_plan <- rzonation::zonation(
        E_features,
        settings = list("removal rule" = 2, "edge removal" = 0, "warp factor" = 1)
      )
    
      evwoi <- apr(loss, E_plan, E_features)
    
      dist_features <- apply(features, 3, brick)
    
      dist_plans <-
        lapply(
          dist_features,
          function(x) {
            rzonation::zonation(
              x,
              settings = list(
                "removal rule" = 2, "edge removal" = 0, "warp factor" = 1
                )
              )
          }
        )
    
      vwpi <-
        mapply(
          apr,
          pln = dist_plans,
          fs = dist_features,
          MoreArgs = list(loss = loss),
          SIMPLIFY = TRUE
        )
    
      evwpi <- mean(vwpi)
    
      evpi <- evwpi - evwoi
    
      plot_matrix <-
        function(x, y, nrow, ncol, labels, cell_size, grey_cell = integer(0)) {
        cell_size <- rep(cell_size, length.out =  2)
    
        grey_cell_ind <- arrayInd(grey_cell, .dim = c(nrow, ncol))
    
        for (i in seq_along(grey_cell)) {
          rect(
            x + grey_cell_ind[i, 1] * cell_size[1] - cell_size[1],
            y - grey_cell_ind[i, 2] * cell_size[2],
            x + grey_cell_ind[i, 1] * cell_size[1],
            y - grey_cell_ind[i, 2] * cell_size[2] + cell_size[2],
            col = "grey75",
            border = NA
          )
        }
    
        text(
          rep(
            seq(x, by = cell_size[1], length.out = ncol) + cell_size[1] / 2,
            ncol
          ),
          rep(
            seq(y, by = -cell_size[2], length.out = nrow) - cell_size[2] / 2,
            each = nrow
          ),
          labels = labels
        )
        segments(
          c(rep(x, ncol + 1), seq(x, by = cell_size[1], length.out = ncol + 1)),
          c(seq(y, by = -cell_size[2], length.out = nrow + 1), rep(y, nrow + 1)),
          c(
            rep(x + cell_size[1] * ncol, ncol + 1),
            seq(x, by = cell_size[1], length.out = ncol + 1)
          ),
          c(
            seq(y, by = -cell_size[2], length.out = nrow + 1),
            rep(y - cell_size[2] * nrow, nrow + 1)
          )
        )
      }
    
      tbl <- mapply(
        function(x, y) na.omit(as.integer(t(features[, , x, y]) * 100)),
        rep(1:2, 2),
        rep(1:2, each = 2)
      )
    
      Etbl <- na.omit(apply(E_features[] * 100, 2, as.integer))
    
      ranks <- sapply(
        seq_len(n_layers),
        function(x) {
          rank(
            -na.omit(
              as.numeric(t(raster::as.matrix(dist_plans[[x]]$rasters$rank)))
            )
          )
        }
      )
    
      E_rank <-
        rank(-na.omit(as.numeric(t(raster::as.matrix(E_plan$rasters$rank)))))
    
    
      par(mar = rep(0, 4), ps = 8)
      plot.new()
      plot.window(xlim = c(0, 2.7), ylim = c(0, 2.3))
    
      text(.35, 2.25, "Species 1", pos = 3, cex = 1.3)
      text(.95, 2.25, "Species 2", pos = 3, cex = 1.3)
      text(1.75, 2.25, "Rank", pos = 3, cex = 1.3)
      text(
        .1, 1.95, expression(paste("E[", italic(K), "]")), pos = 2, cex = 1.3
      )
      text(.1, 1.05, expression(italic(k)[1]), pos = 2, cex = 1.3)
      text(.1, .35, expression(italic(k)[2]), pos = 2, cex = 1.3)
      text(.05, c(1.55, .65, -.05), "Total", pos = 3, cex = 1.1)
      segments(.1, 1.45, 2)
      segments(1.35, 2.2, 1.35, .1)
    
      plot_matrix(.1, 2.2, 5, 5, Etbl[, 1], .1, which.min(E_rank))
      text(.35, 1.55, sum(Etbl[, 1]), pos = 3, cex = 1.1)
    
      plot_matrix(.7, 2.2, 5, 5, Etbl[, 2], .1, which.min(E_rank))
      text(.95, 1.55, sum(Etbl[, 2]), pos = 3, cex = 1.1)
    
      plot_matrix(1.5, 2.2, 5, 5, E_rank, .1, which.min(E_rank))
    
      text(
        2.1,
        1.95,
        bquote(
          plain("EVWOI") ==
          frac(
            frac(.(Etbl[which.min(E_rank), 1]), .(sum(Etbl[, 1]))) +
            frac(.(Etbl[which.min(E_rank), 2]), .(sum(Etbl[, 2]))),
            2
          )
        ),
        pos = 4,
        cex = 1.4
      )
    
      text(
        2.1,
        1.75,
        bquote(phantom(plain("EVWOI")) == .(round(evwoi, 2))),
        pos = 4,
        cex = 1.4
      )
    
      plot_matrix(.1, 1.3, 5, 5, tbl[, 1], .1, which.min(ranks[, 1]))
      text(.35, .65, sum(tbl[, 1]), pos = 3, cex = 1.1)
    
      plot_matrix(.1, .6, 5, 5, tbl[, 2], .1, which.min(ranks[, 2]))
      text(.35, -.05, sum(tbl[, 2]), pos = 3, cex = 1.1)
    
      plot_matrix(.7, 1.3, 5, 5, tbl[, 3], .1, which.min(ranks[, 1]))
      text(.95, .65, sum(tbl[, 3]), pos = 3, cex = 1.1)
    
      plot_matrix(.7, .6, 5, 5, tbl[, 4], .1, which.min(ranks[, 2]))
      text(.95, -.05, sum(tbl[, 4]), pos = 3, cex = 1.1)
    
      plot_matrix(1.5, 1.3, 5, 5, ranks[, 1], .1, which.min(ranks[, 1]))
    
      plot_matrix(1.5, .6, 5, 5, ranks[, 2], .1, which.min(ranks[, 2]))
    
      text(
        2.1,
        1.05,
        bquote(
          plain("EVWPI") ==
            frac(
              frac(
                frac(.(tbl[which.min(ranks[, 1]), 1]), .(sum(tbl[, 1]))) +
                frac(.(tbl[which.min(ranks[, 1]), 3]), .(sum(tbl[, 3]))),
                2
              ) +
              frac(
                frac(.(tbl[which.min(ranks[, 2]), 2]), .(sum(tbl[, 2]))) +
                frac(.(tbl[which.min(ranks[, 2]), 4]), .(sum(tbl[, 4]))),
                2
              ),
              2
            )
        ),
        pos = 4,
        cex = 1.4
      )
    
      text(
        2.1,
        .85,
        bquote(phantom(plain("EVWPI")) == .(round(evwpi, 2))),
        pos = 4,
        cex = 1.4
      )
    
      text(
        2.1,
        .35,
        bquote(plain("EVPI") == plain("EVWPI") - plain("EVWOI")),
        pos = 4,
        cex = 1.4
      )
    
      text(
        2.1,
        .25,
        bquote(
          phantom(plain("EVPI")) == .(round(evwpi, 2)) - .(round(evwoi, 2))
        ),
        pos = 4,
        cex = 1.4
      )
    
      text(
        2.1,
        .15,
        bquote(phantom(plain("EVPI")) == .(round(evpi, 2))),
        pos = 4,
        cex = 1.4
      )
    }
  )
```

***

